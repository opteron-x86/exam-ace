{% extends "base.html" %}
{% block title %}Quiz History{% endblock %}

{% block content %}
<div class="history-container">
    <h1>Quiz History</h1>

    <!-- Summary Stats -->
    <section class="stats-bar">
        <div class="stat-card">
            <div class="stat-value">{{ stats.sessions.total_attempts or 0 }}</div>
            <div class="stat-label">Total Attempts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.sessions.exam_attempts or 0 }}</div>
            <div class="stat-label">Exam Mode</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ stats.sessions.study_attempts or 0 }}</div>
            <div class="stat-label">Study Mode</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {% if stats.sessions.total_attempts and stats.sessions.pass_count is not none %}
                    {{ "%.0f"|format((stats.sessions.pass_count or 0) / (stats.sessions.total_attempts or 1) * 100) }}%
                {% else %}0%{% endif %}
            </div>
            <div class="stat-label">Pass Rate</div>
        </div>
    </section>

    <!-- Score Trend -->
    {% if stats.recent_scores %}
    <section class="card">
        <h2>Recent Scores</h2>
        <div class="score-trend">
            {% for score in stats.recent_scores|reverse %}
            <div class="trend-bar-wrapper" title="{{ score.started_at[:10] }} – {{ score.scaled_score }}/900">
                <div class="trend-bar {% if score.scaled_score >= 710 %}good{% else %}poor{% endif %}"
                     style="height: {{ (score.scaled_score / 900 * 100)|int }}%">
                </div>
                <div class="trend-label">{{ score.scaled_score }}</div>
            </div>
            {% endfor %}
        </div>
        <div class="trend-line-label">Passing: 710</div>
    </section>
    {% endif %}

    <!-- Session List -->
    <section class="card">
        <h2>All Attempts</h2>
        <div class="filter-row">
            <button class="btn btn-sm btn-outline active" data-filter="all">All</button>
            <button class="btn btn-sm btn-outline" data-filter="exam">Exam</button>
            <button class="btn btn-sm btn-outline" data-filter="study">Study</button>
        </div>

        {% if sessions %}
        <div class="session-table">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Mode</th>
                        <th>Questions</th>
                        <th>Score</th>
                        <th>Scaled</th>
                        <th>Result</th>
                        <th>Time</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in sessions %}
                    <tr class="session-row" data-mode="{{ s.mode }}">
                        <td>{{ s.started_at[:16].replace('T', ' ') if s.started_at else '—' }}</td>
                        <td><span class="badge {{ s.mode }}">{{ s.mode|capitalize }}</span></td>
                        <td>{{ s.correct_count or 0 }}/{{ s.total_questions }}</td>
                        <td>{{ "%.1f"|format(s.score_percentage or 0) }}%</td>
                        <td>{{ s.scaled_score or '—' }}</td>
                        <td>
                            {% if s.completed_at %}
                                {% if s.passed %}<span class="badge pass">Pass</span>
                                {% else %}<span class="badge fail">Fail</span>{% endif %}
                            {% else %}
                                <span class="badge">Incomplete</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set mins = (s.time_spent_seconds or 0) // 60 %}
                            {{ mins }}m
                        </td>
                        <td class="actions-cell">
                            {% if s.completed_at %}
                            <a href="/results/{{ s.id }}" class="btn btn-xs btn-outline">Review</a>
                            {% endif %}
                            <button class="btn btn-xs btn-danger delete-btn" data-id="{{ s.id }}">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="empty-state">No quiz attempts yet. Start a quiz from the home page!</p>
        {% endif %}
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Filter buttons
    document.querySelectorAll('.filter-row .btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-row .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filter = btn.dataset.filter;
            document.querySelectorAll('.session-row').forEach(row => {
                if (filter === 'all') row.style.display = '';
                else row.style.display = row.dataset.mode === filter ? '' : 'none';
            });
        });
    });

    // Delete buttons
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            if (!confirm('Delete this quiz attempt?')) return;
            const id = btn.dataset.id;
            await fetch(`/api/history/${id}`, { method: 'DELETE' });
            btn.closest('tr').remove();
        });
    });
});
</script>
{% endblock %}
